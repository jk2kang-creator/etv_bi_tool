<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì—í‹°ë²„ìŠ¤ì´ë¹„í‹° ì†ìµí˜„í™© ë¶„ì„ (v1.3.51)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* --- ê¸°ì¡´ UI ìŠ¤íƒ€ì¼ ìœ ì§€ --- */
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#1f2a37; --muted:#6b7280; --border:#e5e7eb;
      --primary:#1f5eff; --primary-2:#0b4bd6; --danger:#e11d48; --success:#10b981;
      --radius: 12px;
      --font: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Noto Sans KR", sans-serif;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--font); -webkit-font-smoothing: antialiased; }

    .app{ min-height:100vh; display:grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr; grid-template-areas: "head head" "lnb body"; transition: grid-template-columns 0.3s ease; }
    .app.lnb-hidden { grid-template-columns: 0px 1fr; }
    
    header{ grid-area:head; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:#0f2342; color:#fff; position:sticky; top:0; z-index:100; }
    .brand-wrap { display:flex; align-items:center; gap:12px; }
    .menu-toggle { background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; outline: none; transition: 0.2s; }
    .menu-toggle:hover { color: #94a3b8; }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:800; font-size:16px; letter-spacing:-.5px; }
    .pill { background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:6px; font-size:10px; font-weight:400; margin-left:8px; border:1px solid rgba(255,255,255,0.2); }
    
    nav{ grid-area:lnb; padding:15px; border-right:1px solid var(--border); background:#fff; position:sticky; top:64px; height:calc(100vh - 64px); overflow-y:auto; display:flex; flex-direction:column; gap:4px; transition: padding 0.3s ease, opacity 0.2s ease; overflow-x: hidden; white-space: nowrap; }
    .app.lnb-hidden nav { padding-left: 0; padding-right: 0; border-right: none; opacity: 0; pointer-events: none; }
    
    .lnb-title { font-size:11px; color:#94a3b8; font-weight:700; margin:8px 0 4px 10px; text-transform:uppercase; }
    .lnb-item{ display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; cursor:pointer; color:#475569; transition:0.2s; text-decoration: none; font-size: 13px; }
    .lnb-item.active{ background:#eff6ff; color:#2563eb; font-weight:700; }
    .lnb-ico{ font-size:16px; width:20px; text-align:center; }
    .lnb-sub{ font-size:10px; color:#94a3b8; margin-top:1px; font-weight:400; }
    .lnb-divider { height:1px; background:var(--border); margin:10px 0; }

    main{ grid-area:body; padding:20px; max-width:1800px; overflow-y:auto; min-width: 0; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow: 0 2px 4px rgba(0,0,0,0.02); padding:16px; margin-bottom:16px; }
    .card .hd{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid var(--border); }
    .card .hd h3{ margin:0; font-size:15px; font-weight:700; color:#1e293b; }

    .edit-mode-toggle { display: flex; align-items: center; gap: 8px; height: 36px; padding: 0 12px; background: #f1f5f9; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
    .edit-mode-toggle.disabled { opacity: 0.5; cursor: not-allowed; background: #e2e8f0; }
    .edit-mode-toggle span { font-size: 11px; font-weight: 600; color: #2563eb; }
    .edit-mode-toggle.disabled span { color: var(--muted); }

    .top-actions { display:flex; align-items:center; gap:8px; }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:end; }
    .field{ display:flex; flex-direction:column; gap:4px; min-width:100px; }
    label{ font-size:11px; font-weight:600; color:var(--muted); }
    input, select{ height:36px; border-radius:6px; border:1px solid var(--border); padding:0 10px; font-size:12px; outline:none; background:#fff; }

    .btn{ height:36px; padding:0 12px; border-radius:6px; border:1px solid var(--border); font-weight:600; font-size:11px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; transition:0.2s; justify-content: center; }
    .btn.primary{ background:var(--primary); color:#fff; border:none; }
    .btn.success { background:var(--success); color:#fff; border:none; }
    .btn.outline { background: #fff; color: var(--text); }

    .table-container{ overflow-x:auto; overflow-y:visible; border:1px solid var(--border); border-radius:8px; background: #fff; margin-bottom: 8px; position: relative; }
    .table-container::-webkit-scrollbar { height: 10px; }
    .table-container::-webkit-scrollbar-track { background: #f8fafc; border-radius: 8px; }
    .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; border: 2px solid #f8fafc; }
    .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    table{ width: 100%; min-width: max-content; border-collapse:collapse; font-size:12px; table-layout: fixed; }
    th{ position:sticky; top:0; background:#f8fafc; padding:8px; border:1px solid var(--border); z-index: 10; text-align:center; color:#64748b; }
    td{ padding:4px 8px; border:1px solid var(--border); color:#334155; height: 32px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .sticky-col { position: sticky; left: 0; z-index: 12; }
    th.sticky-col { z-index: 20; background-color: #f8fafc !important; border-right: 2px solid #cbd5e1 !important; box-shadow: 2px 0 4px rgba(0,0,0,0.03); }
    td.sticky-col { z-index: 15; background-color: #f1f5f9 !important; border-right: 2px solid #cbd5e1 !important; box-shadow: 2px 0 4px rgba(0,0,0,0.03); }

    .resizer { position: absolute; top: 0; right: 0; width: 4px; cursor: col-resize; user-select: none; height: 100%; z-index: 25; }
    .resizer:hover { background: var(--primary); }

    .table-input { width: 100%; border: 1px solid transparent; background: transparent; text-align: right; padding: 2px 4px; font-family: 'Courier New', monospace; font-size: 12px; font-weight: 700; color: #334155; border-radius: 4px; pointer-events: none; transition: all 0.2s; }
    .edit-active .table-input:not([readonly]) { pointer-events: auto; border-color: #cbd5e1; background: #ffffff; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); color: #0f172a; }
    .edit-active .table-input:not([readonly]):hover { border-color: #94a3b8; }
    .edit-active .table-input:not([readonly]):focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(31, 94, 255, 0.2); background: #ffffff; outline: none; }
    
    .right{ text-align:right; } .center{ text-align:center; } .mono{ font-family:'Courier New', monospace; font-weight:600; }
    .bg-total { background-color: #f1f5f9 !important; font-weight: 800; }
    .highlight-row { background-color: #fffbeb !important; font-weight: 700; }
    .achieve-rate { font-size: 10px; color: var(--primary); font-weight: 500; margin-left: 4px; }
    .font-bold { font-weight: 800; }
    .text-success { color: var(--success); font-weight: 700; }
    .text-danger { color: var(--danger); font-weight: 700; }
    
    /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .chart-container { position: relative; height: 280px; width: 100%; margin-top: 10px; }
  </style>
</head>
<body>

<div class="app" id="appContainer">
  <header>
    <div class="brand-wrap">
      <button class="menu-toggle" onclick="toggleLNB()" title="ë©”ë‰´ ì—´ê¸°/ìˆ¨ê¸°ê¸°">&#9776;</button>
      <div class="brand">ğŸ“Š ì—í‹°ë²„ìŠ¤ì´ë¹„í‹° ì£¼ìš” ì§€í‘œ í˜„í™© <span class="pill">v1.3.51</span></div>
    </div>
    <div class="user"><strong style="font-size:12px">Admin</strong></div>
  </header>

  <nav>
    <div class="lnb-title">EBT Management</div>
    <div class="lnb-item active"><div class="lnb-ico">ğŸ“‰</div><div><div>ì†ìµí˜„í™©</div><div class="lnb-sub">ì „ì‚¬ ë¶„ì„</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ¯</div><div><div>ëª©í‘œí˜„í™©</div><div class="lnb-sub">ëª©í‘œë‹¬ì„±ìœ¨</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ’°</div><div><div>ë§¤ì¶œí˜„í™©</div><div class="lnb-sub">ì¶œí•˜ì™„ë£Œ ê¸°ì¤€</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ“¦</div><div><div>ì¬ê³ í˜„í™©</div><div class="lnb-sub">ì¬ê³  ë¶„ì„</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ§¾</div><div><div>ë¯¸ìˆ˜ê¸ˆí˜„í™©</div><div class="lnb-sub">Phase 2</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ“„</div><div><div>ë¯¸ë°œí–‰í˜„í™©</div><div class="lnb-sub">ì„¸ê¸ˆê³„ì‚°ì„œ</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ¦</div><div><div>ìš´ì „ìê¸ˆí˜„í™©</div><div class="lnb-sub">Cash Flow</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ·ï¸</div><div><div>ë¦¬ë² ì´íŠ¸ í˜„í™©</div><div class="lnb-sub">Vendor Rebate</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">â†©ï¸</div><div><div>ë°˜í’ˆì´ë ¥ì¡°íšŒ</div><div class="lnb-sub">Return History</div></div></div>
    <div class="lnb-divider"></div>
    <div class="lnb-item"><div class="lnb-ico">âš™ï¸</div><div><div>ê´€ë¦¬ì ì„¤ì •</div><div class="lnb-sub">System</div></div></div>
  </nav>

  <main id="mainContainer">
    <div class="card">
      <div class="hd">
        <h3>ì†ìµ ë°ì´í„° ê²€ìƒ‰ ë° ê´€ë¦¬</h3>
        <div class="top-actions">
          <button class="btn outline" onclick="document.getElementById('fileInput').click()">â¬†ï¸ ê¸°ì´ˆìë£Œ ì—…ë¡œë“œ</button>
          <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(event)">
          <button class="btn outline" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <label class="edit-mode-toggle" id="editToggleLabel" title="ìˆ˜ì • ëª¨ë“œëŠ” ì›”ë³„ ì¡°íšŒ ì‹œì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.">
            <input type="checkbox" id="editToggle" onchange="toggleEditMode()">
            <span>ìˆ˜ì • ëª¨ë“œ</span>
          </label>
          <button class="btn success" onclick="alert('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
      <div class="controls">
        <div class="field">
          <label>ì¡°íšŒ ê¸°ì¤€</label>
          <select id="viewType" onchange="toggleViewInputs()">
            <option value="month">ì›”ë³„ ë¹„êµ</option>
            <option value="year">ì—°ë„ë³„ ë¹„êµ (3ê°œë…„ ë“±)</option>
          </select>
        </div>
        <div class="field view-month"><label>ì‹œì‘ ì›”</label><input type="month" id="startMonth" value="2025-10"></div>
        <div class="field view-month"><label>ì¢…ë£Œ ì›”</label><input type="month" id="endMonth" value="2026-09"></div>
        <div class="field view-year" style="display:none;"><label>ì‹œì‘ ì—°ë„</label><input type="number" id="startYear" value="2024" min="2000" max="2100"></div>
        <div class="field view-year" style="display:none;"><label>ì¢…ë£Œ ì—°ë„</label><input type="number" id="endYear" value="2026" min="2000" max="2100"></div>
        <div class="field"><label>ë³¸ë¶€</label><select><option>ì „ì²´</option></select></div>
        <div class="field"><label>ë¶€ì„œ</label><select><option>ì „ì²´</option></select></div>
        <button class="btn primary" onclick="renderDynamicTables()">ğŸ” ì¡°íšŒ</button>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h3 id="chartTitle">ì†ìµ ì¶”ì´ ì‹œê°í™” (ë§¤ì¶œì•¡ ë° ì˜ì—…ì´ìµë¥ )</h3>
      </div>
      <div class="chart-container">
        <canvas id="profitChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h3 id="profitTitle">ì£¼ìš” ì†ìµ ì‹¤ì  í˜„í™©</h3></div>
      <div class="table-container" id="profitTableArea"></div>
    </div>

    <div class="card">
      <div class="hd"><h3 id="sgaTitle">íŒë§¤ê´€ë¦¬ í˜„í™© ìƒì„¸ ë‚´ì—­</h3></div>
      <div class="table-container" id="sgaTableArea"></div>
    </div>
  </main>
</div>

<script>
  // Chart.js ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ìš© ë³€ìˆ˜
  let profitChartInstance = null;

  function toggleLNB() { document.getElementById('appContainer').classList.toggle('lnb-hidden'); }
  
  function toggleEditMode() { 
    if(!document.getElementById('editToggle').disabled) {
      document.getElementById('mainContainer').classList.toggle('edit-active', document.getElementById('editToggle').checked);
    }
  }

  function toggleViewInputs() {
    const isYear = document.getElementById('viewType').value === 'year';
    document.querySelectorAll('.view-month').forEach(el => el.style.display = isYear ? 'none' : 'flex');
    document.querySelectorAll('.view-year').forEach(el => el.style.display = isYear ? 'flex' : 'none');

    const editToggle = document.getElementById('editToggle');
    const editLabel = document.getElementById('editToggleLabel');
    if (isYear) {
      editToggle.checked = false;
      editToggle.disabled = true;
      editLabel.classList.add('disabled');
      document.getElementById('mainContainer').classList.remove('edit-active');
    } else {
      editToggle.disabled = false;
      editLabel.classList.remove('disabled');
    }
  }

  function renderDynamicTables() {
    const viewType = document.getElementById('viewType').value;
    let periods = [];
    
    if (viewType === 'month') {
      const start = document.getElementById('startMonth').value;
      const end = document.getElementById('endMonth').value;
      let c = new Date(start + "-01"), l = new Date(end + "-01");
      while(c <= l) { periods.push(c.getFullYear() + "-" + String(c.getMonth() + 1).padStart(2, '0')); c.setMonth(c.getMonth() + 1); }
      document.getElementById('profitTitle').innerText = "ì£¼ìš” ì†ìµ ì‹¤ì  í˜„í™© (ì›”ë³„)";
      document.getElementById('sgaTitle').innerText = "íŒë§¤ê´€ë¦¬ í˜„í™© ìƒì„¸ ë‚´ì—­ (ì›”ë³„)";
      document.getElementById('chartTitle').innerText = "ì›”ë³„ ì†ìµ ì¶”ì´ (ë§¤ì¶œì•¡ ë° ì˜ì—…ì´ìµë¥ )";
    } else {
      const start = parseInt(document.getElementById('startYear').value);
      const end = parseInt(document.getElementById('endYear').value);
      for(let i=start; i<=end; i++) periods.push(i + "ë…„");
      document.getElementById('profitTitle').innerText = "ì£¼ìš” ì†ìµ ì‹¤ì  í˜„í™© (ì—°ë„ë³„ ë¹„êµ)";
      document.getElementById('sgaTitle').innerText = "íŒë§¤ê´€ë¦¬ í˜„í™© ìƒì„¸ ë‚´ì—­ (ì—°ë„ë³„ ë¹„êµ)";
      document.getElementById('chartTitle').innerText = "ì—°ë„ë³„ ì†ìµ ì¶”ì´ (ë§¤ì¶œì•¡ ë° ì˜ì—…ì´ìµë¥ )";
    }

    const multiplier = viewType === 'year' ? 12 : 1; 

    // ë°ì´í„° ì •ì˜
    const profitItems = [
      { id: 'sales', label: 'ë§¤ì¶œì•¡', val: 125000 * multiplier },
      { id: 'cost', label: 'ë§¤ì¶œì›ê°€', val: 110000 * multiplier },
      { id: 'gp', label: 'ë§¤ì¶œì´ì´ìµ', val: 15000 * multiplier, cls: 'highlight-row' },
      { id: 'gp_rate', label: 'ë§¤ì¶œì´ì´ìµìœ¨', val: 12.0, isRate: true, bold: true },
      { id: 'sga', label: 'íŒë§¤ê´€ë¦¬ë¹„', val: 8500 * multiplier },
      { id: 'op', label: 'ì˜ì—…ì´ìµ', val: 6500 * multiplier, cls: 'highlight-row' },
      { id: 'op_rate', label: 'ì˜ì—…ì´ìµìœ¨', val: 5.2, isRate: true, bold: true }
    ];
    
    // ì°¨íŠ¸ ë Œë”ë§ì„ ìœ„í•œ ë°ì´í„° ìˆ˜ì§‘ ë°°ì—´
    let chartSalesData = [];
    let chartOpMarginData = [];

    // [1] ì£¼ìš” ì†ìµ í…Œì´ë¸” ìƒì„±
    let pHeader = `<thead><tr><th style="width:160px; min-width:160px;" class="sticky-col">í•­ëª©</th>`;
    periods.forEach(p => pHeader += `<th style="width:110px; min-width:110px;">${p} ì‹¤ì </th>`);
    
    if (viewType === 'month') {
      pHeader += `<th style="width:180px; min-width:180px;">ëˆ„ì  ì‹¤ì (ë‹¬ì„±ë¥ )</th><th style="width:140px; min-width:140px;">ëª©í‘œ í•©ê³„</th></tr></thead>`;
    } else {
      pHeader += `<th class="bg-total" style="width:140px; min-width:140px;">ê¸°ê°„ í‰ê·  ì‹¤ì </th><th class="bg-total" style="width:160px; min-width:160px;">ìµœê·¼ë…„ë„ ì¦ê°ë¥ (YoY)</th></tr></thead>`;
    }
    
    let pBody = `<tbody>`;
    profitItems.forEach(item => {
      const rowStyle = item.bold ? 'font-weight:800; background-color:#f8fafc;' : '';
      pBody += `<tr class="${item.cls || ''}" style="${rowStyle}"><td class="center bg-total font-bold sticky-col">${item.label}</td>`;
      
      let rowSum = 0;
      let periodVals = [];
      periods.forEach((p, idx) => {
        let periodVal = item.isRate ? (item.val + (idx * 0.1)) : (item.val * (1+(idx*0.02)));
        periodVals.push(periodVal);
        rowSum += periodVal;
        
        // ì°¨íŠ¸ ë°ì´í„° ì ì¬
        if (item.id === 'sales') chartSalesData.push(periodVal);
        if (item.id === 'op_rate') chartOpMarginData.push(periodVal);

        let displayVal = item.isRate ? periodVal.toFixed(1) + "%" : Math.floor(periodVal).toLocaleString();
        const isReadonly = viewType === 'year' ? 'readonly' : '';
        pBody += `<td><input type="text" class="table-input" style="${item.bold?'font-weight:800':''}" value="${displayVal}" ${isReadonly}></td>`;
      });

      if (viewType === 'month') {
        const targetSum = item.isRate ? (item.val + 1.5) : (item.val * 12);
        let cumulativeDisplay = item.isRate ? `${(rowSum / periods.length).toFixed(1)}%` : `${Math.floor(rowSum).toLocaleString()} <span class="achieve-rate">(${((rowSum / targetSum) * 100).toFixed(1)}%)</span>`;
        const targetDisplay = item.isRate ? targetSum.toFixed(1) + "%" : Math.floor(targetSum).toLocaleString();
        pBody += `<td><div class="right mono">${cumulativeDisplay}</div></td><td><div class="right mono">${targetDisplay}</div></td></tr>`;
      } else {
        let avgVal = rowSum / periods.length;
        let avgDisplay = item.isRate ? avgVal.toFixed(1) + "%" : Math.floor(avgVal).toLocaleString();
        
        let yoyDisplay = "-";
        if (periodVals.length >= 2) {
          let lastVal = periodVals[periodVals.length - 1];
          let prevVal = periodVals[periodVals.length - 2];
          
          if (item.isRate) {
            let diff = lastVal - prevVal;
            let sign = diff > 0 ? "+" : "";
            yoyDisplay = `<span class="${diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : '')}">${sign}${diff.toFixed(1)}%p</span>`;
          } else {
            let yoy = ((lastVal / prevVal) - 1) * 100;
            let sign = yoy > 0 ? "+" : "";
            yoyDisplay = `<span class="${yoy > 0 ? 'text-success' : (yoy < 0 ? 'text-danger' : '')}">${sign}${yoy.toFixed(1)}%</span>`;
          }
        }
        pBody += `<td><div class="right mono bg-total">${avgDisplay}</div></td><td><div class="right mono bg-total">${yoyDisplay}</div></td></tr>`;
      }
    });
    pBody += `</tbody>`;
    document.getElementById('profitTableArea').innerHTML = `<table id="profitTable">${pHeader}${pBody}</table>`;
    initResizable('profitTable');

    // [2] íŒë§¤ê´€ë¦¬ ìƒì„¸ í…Œì´ë¸” ìƒì„±
    const sgaItems = [{ label: 'ì¸ê±´ë¹„', val: 12500 * multiplier }, { label: 'ë³µë¦¬í›„ìƒë¹„', val: 1200 * multiplier }, { label: 'ì„ì°¨ë£Œ', val: 5000 * multiplier }];
    let sHeader = `<thead><tr><th style="width:160px; min-width:160px;" class="sticky-col">í•­ëª©</th>`;
    periods.forEach(p => sHeader += `<th style="width:110px; min-width:110px;">${p} ì‹¤ì </th>`);
    
    if (viewType === 'month') {
      sHeader += `<th class="bg-total" style="width:140px; min-width:140px;">ì§‘í–‰ ëˆ„ì ì•¡</th><th class="bg-total" style="width:140px; min-width:140px;">ì§‘í–‰ í‰ê· ì•¡</th></tr></thead><tbody>`;
    } else {
      sHeader += `<th class="bg-total" style="width:140px; min-width:140px;">ê¸°ê°„ í‰ê·  ì‹¤ì </th><th class="bg-total" style="width:160px; min-width:160px;">ìµœê·¼ë…„ë„ ì¦ê°ë¥ (YoY)</th></tr></thead><tbody>`;
    }

    sgaItems.forEach(item => {
      let total = 0;
      let sgaVals = [];
      sHeader += `<tr><td class="center bg-total font-bold sticky-col">${item.label}</td>`;
      periods.forEach((p, idx) => {
        let periodVal = item.val * (1+(idx*0.01));
        sgaVals.push(periodVal);
        total += periodVal;
        const isReadonly = viewType === 'year' ? 'readonly' : '';
        sHeader += `<td><input type="text" class="table-input" value="${Math.floor(periodVal).toLocaleString()}" ${isReadonly}></td>`;
      });
      
      if (viewType === 'month') {
        sHeader += `<td class="right mono bg-total text-primary">${Math.floor(total).toLocaleString()}</td>`;
        sHeader += `<td class="right mono bg-total">${Math.floor(total/periods.length).toLocaleString()}</td></tr>`;
      } else {
        let avgVal = total / periods.length;
        let yoyDisplay = "-";
        if (sgaVals.length >= 2) {
          let lastVal = sgaVals[sgaVals.length - 1];
          let prevVal = sgaVals[sgaVals.length - 2];
          let yoy = ((lastVal / prevVal) - 1) * 100;
          let sign = yoy > 0 ? "+" : "";
          yoyDisplay = `<span class="${yoy > 0 ? 'text-danger' : (yoy < 0 ? 'text-success' : '')}">${sign}${yoy.toFixed(1)}%</span>`;
        }
        sHeader += `<td class="right mono bg-total">${Math.floor(avgVal).toLocaleString()}</td>`;
        sHeader += `<td class="right mono bg-total">${yoyDisplay}</td></tr>`;
      }
    });
    sHeader += `</tbody>`;
    document.getElementById('sgaTableArea').innerHTML = `<table id="sgaTable">${sHeader}</table>`;
    initResizable('sgaTable');

    // [3] ì°¨íŠ¸ ë Œë”ë§ í˜¸ì¶œ
    renderChart(periods, chartSalesData, chartOpMarginData);
  }

  function renderChart(labels, salesData, opMarginData) {
    const ctx = document.getElementById('profitChart').getContext('2d');
    
    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ í›„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    if (profitChartInstance) {
      profitChartInstance.destroy();
    }

    profitChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            type: 'line',
            label: 'ì˜ì—…ì´ìµë¥  (%)',
            data: opMarginData,
            borderColor: '#10b981', // Success color
            backgroundColor: '#10b981',
            borderWidth: 2,
            tension: 0.3, // ê³¡ì„  ì²˜ë¦¬
            yAxisID: 'y1'
          },
          {
            type: 'bar',
            label: 'ë§¤ì¶œì•¡',
            data: salesData,
            backgroundColor: 'rgba(31, 94, 255, 0.7)', // Primary color
            borderColor: '#1f5eff',
            borderWidth: 1,
            borderRadius: 4,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 8, font: { size: 11, family: 'Pretendard' } } }
        },
        scales: {
          x: { 
            grid: { display: false },
            ticks: { font: { family: 'Pretendard', size: 11 } }
          },
          y: {
            type: 'linear', display: true, position: 'left',
            title: { display: true, text: 'ë§¤ì¶œì•¡', font: { family: 'Pretendard', size: 10 } },
            ticks: { font: { family: 'Pretendard', size: 10 } }
          },
          y1: {
            type: 'linear', display: true, position: 'right',
            grid: { drawOnChartArea: false }, // ë§¤ì¶œì•¡ ê²©ìì„ ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ ì²˜ë¦¬
            title: { display: true, text: 'ì´ìµë¥  (%)', font: { family: 'Pretendard', size: 10 } },
            ticks: { font: { family: 'Pretendard', size: 10 } }
          }
        }
      }
    });
  }

  function initResizable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    table.querySelectorAll('th').forEach(col => {
      const resizer = document.createElement('div');
      resizer.className = 'resizer';
      col.appendChild(resizer);
      resizer.addEventListener('mousedown', function(e) {
        const startX = e.pageX;
        const startWidth = col.offsetWidth;
        const onMouseMove = (e) => {
          const width = startWidth + (e.pageX - startX);
          if (width > 60) {
            col.style.width = width + 'px';
            col.style.minWidth = width + 'px';
          }
        };
        const onMouseUp = () => {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    });
  }

  function downloadExcel() {
    const wb = XLSX.utils.book_new();
    document.querySelectorAll('table').forEach((table, idx) => {
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, `Sheet${idx + 1}`);
    });
    XLSX.writeFile(wb, `Etevers_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) { alert(`${file.name} ì—…ë¡œë“œ ì™„ë£Œ`); renderDynamicTables(); }
  }

  window.onload = renderDynamicTables;
</script>
</body>
</html>