<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¦¬ë² ì´íŠ¸ ë¶„ì„ ì‹œìŠ¤í…œ (v1.3.99)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* --- ë””ìì¸ ì‹œìŠ¤í…œ --- */
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#1f2a37; --muted:#6b7280; --border:#e5e7eb;
      --primary:#1f5eff; --primary-2:#0b4bd6; --danger:#e11d48; --success:#10b981;
      --warning:#f59e0b; --radius: 12px;
      --font: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Noto Sans KR", sans-serif;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--font); -webkit-font-smoothing: antialiased; overflow: hidden; }

    .app{ height:100vh; display:grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr; grid-template-areas: "head head" "lnb body"; transition: 0.3s ease; }
    .app.lnb-hidden { grid-template-columns: 0px 1fr; }
    
    header{ grid-area:head; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:#0f2342; color:#fff; z-index:100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .brand-wrap { display:flex; align-items:center; gap:12px; }
    .menu-toggle { background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer; outline: none; }
    .brand{ font-weight:800; font-size:16px; letter-spacing:-.5px; }
    .pill { background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:6px; font-size:10px; border:1px solid rgba(255,255,255,0.2); margin-left:8px; }
    
    nav{ grid-area:lnb; padding:20px 15px; border-right:1px solid var(--border); background:#fff; overflow-y:auto; display:flex; flex-direction:column; gap:8px; transition: 0.3s; }
    .lnb-title { font-size:11px; color:#94a3b8; font-weight:700; margin:10px 0 8px 10px; text-transform:uppercase; letter-spacing: 0.5px; }
    .lnb-item{ display:flex; align-items:center; gap:12px; padding:10px 15px; border-radius:10px; cursor:pointer; color:#475569; transition:0.2s; text-decoration: none; font-size: 14px; }
    .lnb-item:hover { background: #f8fafc; color: var(--primary); }
    .lnb-item.active{ background:#eff6ff; color:#2563eb; font-weight:700; }
    .lnb-ico{ font-size:16px; width:20px; text-align:center; }
    .lnb-sub{ font-size:11px; color:#94a3b8; margin-top:2px; font-weight:400; }
    .lnb-divider { height:1px; background:#f1f5f9; margin:12px 0; }

    main{ grid-area:body; padding:20px; overflow-y:auto; min-width: 0; }
    
    .edit-mode-toggle { 
      height: 36px; padding: 0 12px; border-radius: 6px; 
      border: 1px solid var(--border); background: #fff; 
      display: inline-flex; align-items: center; gap: 8px; 
      cursor: pointer; transition: 0.2s; 
    }
    .edit-mode-toggle span { font-size: 11px; font-weight: 600; color: var(--text); }
    .edit-mode-toggle input { cursor: pointer; margin: 0; width: 14px; height: 14px; }
    .edit-mode-toggle.active { background: #eff6ff; border-color: var(--primary); }
    .edit-mode-toggle.active span { color: var(--primary); }

    .table-input { 
      width: 100%; border: 1px solid transparent; background: transparent; 
      text-align: center; padding: 4px 8px; font-family: inherit; 
      font-size: 11px; color: inherit; border-radius: 6px; 
      pointer-events: none; outline: none; appearance: none;
    }
    .table-input.right { text-align: right !important; }
    
    .edit-active .table-input { 
      pointer-events: auto; border: 1px solid #cbd5e1; background: #ffffff; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .edit-active select.table-input {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cpath fill='%236b7280' d='M0 2l4 4 4-4z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 10px center; padding-right: 24px;
    }
    .edit-active .editable-cell { background-color: #fffbeb !important; }

    .data-row { cursor: pointer; transition: background 0.2s; }
    .data-row:hover { background-color: #f8fafc; }
    .data-row.selected { background-color: #e0f2fe !important; border: 2px solid var(--primary); }

    .search-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow: 0 2px 4px rgba(0,0,0,0.02); padding:20px; margin-bottom:16px; }
    .search-hd { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #f1f5f9; }
    .search-hd h3 { margin:0; font-size:15px; font-weight:700; color:#1e293b; }
    .top-actions { display:flex; align-items:center; gap:8px; }
    
    .search-controls { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:12px; font-weight:600; color:var(--text); }
    select, input[type="month"] { height:40px; border-radius:8px; border:1px solid var(--border); padding:0 12px; font-size:13px; outline:none; background:#fff; min-width:140px; }

    .btn{ height:36px; padding:0 12px; border-radius:6px; border:1px solid var(--border); font-weight:600; font-size:11px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; transition:0.2s; justify-content: center; }
    .btn.primary{ background:var(--primary); color:#fff; border:none; height: 40px; padding: 0 20px; font-size: 13px; border-radius: 8px; }
    .btn.success { background:var(--success); color:#fff; border:none; }
    .btn.outline { background: #fff; color: var(--text); }
    .btn.danger-outline { background: #fff; color: var(--danger); border-color: var(--danger); }
    .btn.danger-outline:hover { background: #fff1f2; }

    .table-container{ overflow-x:auto; border:1px solid var(--border); border-radius:8px; background: #fff; margin-bottom: 16px; position: relative; }
    table{ width: 100%; min-width: max-content; border-collapse:collapse; font-size:11px; table-layout: fixed; }
    th{ position:sticky; top:0; background:#f8fafc; padding:8px; border:1px solid var(--border); text-align:center; color:#64748b; font-weight: 700; z-index: 10; }
    td{ padding:4px 8px; border:1px solid var(--border); color:#334155; height: 38px; text-align: center; } 
    
    .resizer { position: absolute; top: 0; right: 0; width: 4px; cursor: col-resize; user-select: none; height: 100%; z-index: 25; }
    .resizer:hover { background: var(--primary); }

    .year-divider td { background-color: #1e293b !important; color: #f8fafc !important; font-weight: 800; font-size: 12px; height: 34px !important; border-bottom: 2px solid #0f172a !important; }

    .right { text-align: right !important; }
    .bg-subtotal { background-color: #f8fafc !important; font-weight: 700; color: #1e293b !important; }
    .bg-total { background-color: #f1f5f9 !important; font-weight: 800; color: #0f172a !important; }
    .sticky-col { position: sticky; left: 0; z-index: 12; width: 100px !important; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid #cbd5e1; }
    .mono { font-family: 'Courier New', monospace; font-weight: 600; }
  </style>
</head>
<body>

<div class="app" id="appContainer">
  <header>
    <div class="brand-wrap">
      <button class="menu-toggle" onclick="toggleLNB()">&#9776;</button>
      <div class="brand">ğŸ“Š ETEVERS GROUP ê²½ì˜ê´€ë¦¬ ì‹œìŠ¤í…œ <span class="pill">v1.3.99</span></div>
    </div>
    <div class="user"><strong style="font-size:12px">ë¹„ì¦ˆë‹ˆìŠ¤ê¸°íšíŒ€ ê°•í˜•êµ¬ ë‹˜</strong></div>
  </header>

  <nav>
    <div class="lnb-title">Management Services</div>
    <a href="#" class="lnb-item"><div class="lnb-ico">ğŸ“‰</div><div>ì†ìµí˜„í™©<div class="lnb-sub">ì „ì‚¬ ë¶„ì„</div></div></a>
    <a href="#" class="lnb-item"><div class="lnb-ico">ğŸ¯</div><div>ëª©í‘œí˜„í™©<div class="lnb-sub">ëª©í‘œë‹¬ì„±ìœ¨</div></div></a>
    <a href="#" class="lnb-item"><div class="lnb-ico">ğŸ’°</div><div>ë§¤ì¶œí˜„í™©<div class="lnb-sub">ì¶œí•˜ì™„ë£Œ ê¸°ì¤€</div></div></a>
    <a href="#" class="lnb-item active"><div class="lnb-ico">ğŸ¦</div><div>ìš´ì „ìê¸ˆí˜„í™©<div class="lnb-sub">Cash Flow</div></div></a>
    <a href="#" class="lnb-item"><div class="lnb-ico">ğŸ·ï¸</div><div>ë¦¬ë² ì´íŠ¸ í˜„í™©<div class="lnb-sub">Vendor Rebate</div></div></a>
    <a href="#" class="lnb-item"><div class="lnb-ico">ğŸ“¦</div><div>ì¬ê³ í˜„í™©<div class="lnb-sub">ì¬ê³  ë¶„ì„</div></div></a>
    <a href="#" class="lnb-item"><div class="lnb-ico">ğŸ§¾</div><div>ë¯¸ìˆ˜ê¸ˆí˜„í™©<div class="lnb-sub">ì±„ê¶Œ ê´€ë¦¬</div></div></a>
    <a href="#" class="lnb-item"><div class="lnb-ico">ğŸ“„</div><div>ë¯¸ë°œí–‰í˜„í™©<div class="lnb-sub">ì„¸ê¸ˆê³„ì‚°ì„œ</div></div></a>
    <a href="#" class="lnb-item"><div class="lnb-ico">â†©ï¸</div><div>ë°˜í’ˆì´ë ¥ì¡°íšŒ<div class="lnb-sub">History</div></div></a>
    <div class="lnb-divider"></div>
    <a href="#" class="lnb-item"><div class="lnb-ico">âš™ï¸</div><div>ê´€ë¦¬ì ì„¤ì •</div></a>
  </nav>

  <main id="mainContainer">
    <div class="search-card">
      <div class="search-hd">
        <h3>ë¦¬ë² ì´íŠ¸(MDF) ì§‘í–‰ í˜„í™© ê´€ë¦¬</h3>
        <div class="top-actions">
          <button class="btn outline" onclick="addMonth()">ğŸ“… ì›” ì¶”ê°€</button>
          <button class="btn danger-outline" onclick="deleteMonth()">ğŸ“… ì›” ì‚­ì œ</button>
          <button class="btn outline" onclick="addRow()">â• ì„ íƒí–‰ ì•„ë˜ ì¶”ê°€</button>
          <button class="btn danger-outline" onclick="deleteRow()">â– ì„ íƒí–‰ ì‚­ì œ</button>
          <label class="edit-mode-toggle" id="editToggleLabel">
            <input type="checkbox" id="editToggle" onchange="toggleEditMode()">
            <span>ìˆ˜ì • ëª¨ë“œ</span>
          </label>
          <button class="btn primary" style="height:36px; font-size:11px;" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn success" onclick="saveData()">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
      
      <div class="search-controls">
        <div class="field"><label>ì‹œì‘ ì›”</label><input type="month" id="startRange" value="2025-10"></div>
        <div class="field"><label>ì¢…ë£Œ ì›”</label><input type="month" id="endRange" value="2026-09"></div>
        <div class="field"><label>ë³¸ë¶€</label><select><option>ì „ì²´</option></select></div>
        <div class="field"><label>ë¶€ì„œ</label><select><option>ì „ì²´</option></select></div>
        <div class="field"><label>ë²¤ë”</label><select><option>ì „ì²´</option><option>HP</option><option>Dell</option></select></div>
        <button class="btn primary">ğŸ” ì¡°íšŒ</button>
      </div>
    </div>

    <div class="table-container">
      <table id="rebateTable">
        <thead>
          <tr>
            <th class="sticky-col">êµ¬ë¶„</th>
            <th style="width:180px">ë¦¬ë² ì´íŠ¸ êµ¬ë¶„</th>
            <th style="width:150px">í”„ë¡œê·¸ë¨ ëª…ì¹­</th>
            <th style="width:110px">ì…ê¸ˆì•¡(A)</th>
            <th style="width:110px">ì´ì›”ê¸ˆì•¡(B)</th>
            <th style="width:110px">(A)+(B)</th>
            <th style="width:110px">ì§€ê¸‰í•©ê³„</th>
            <th style="width:110px">ì§€ê¸‰ì•¡</th>
            <th style="width:140px">ì§€ê¸‰ì—…ì²´</th>
            <th style="width:160px">ì§€ê¸‰ë‚´ìš©</th>
            <th style="width:110px">ì”ì•¡</th>
          </tr>
        </thead>
        <tbody id="rebateBody">
          <tr class="year-divider"><td colspan="11" class="center">2025ë…„</td></tr>
          <tr class="data-row" data-month="2025-10" onclick="selectRow(this)">
            <td rowspan="2" class="sticky-col center month-label">2025ë…„ 10ì›”</td>
            <td class="editable-cell">
              <select class="table-input">
                <option value="sell-In">sell-In</option><option value="sell-Thru">sell-Thru</option>
                <option value="Sell-out">Sell-out</option><option value="MDF">MDF</option>
              </select>
            </td>
            <td class="editable-cell"><input type="text" class="table-input" value="ì´ˆê¸° í”„ë¡œê·¸ë¨"></td>
            <td class="editable-cell"><input type="text" class="table-input right mono val-a" value="1,000,000" oninput="calcAll()"></td>
            <td class="editable-cell"><input type="text" class="table-input right mono val-b" value="500,000" oninput="calcAll()"></td>
            <td class="right mono bg-subtotal row-ab">1,500,000</td>
            <td class="right mono">0</td>
            <td class="editable-cell"><input type="text" class="table-input right mono val-pay" value="1,000,000" oninput="calcAll()"></td>
            <td class="editable-cell"><input type="text" class="table-input" value="ì—…ì²´A"></td>
            <td class="editable-cell"><input type="text" class="table-input mono" value="-"></td>
            <td class="right mono row-balance">500,000</td>
          </tr>
          <tr class="subtotal-row bg-subtotal" data-month="2025-10">
            <td colspan="2" class="center">10ì›” ì†Œê³„</td>
            <td class="right mono m-total-a">0</td><td class="right mono m-total-b">0</td><td class="right mono m-total-ab">0</td>
            <td class="right mono">0</td><td class="right mono m-total-pay">0</td><td colspan="2"></td><td class="right mono m-total-bal">0</td>
          </tr>
        </tbody>
        <tfoot>
            <tr id="totalRow" class="bg-total">
              <td colspan="3" class="center">ì „ì²´ ì´ ëˆ„ì  í•©ê³„</td>
              <td id="totalA" class="right mono">0</td><td id="totalB" class="right mono">0</td><td id="totalAB" class="right mono">0</td>
              <td></td><td id="totalPay" class="right mono">0</td><td colspan="2"></td><td id="totalBal" class="right mono">0</td>
            </tr>
        </tfoot>
      </table>
    </div>
  </main>
</div>

<script>
  let selectedRow = null;

  function toggleLNB() { document.getElementById('appContainer').classList.toggle('lnb-hidden'); }

  function toggleEditMode() {
    const isEdit = document.getElementById('editToggle').checked;
    document.getElementById('mainContainer').classList.toggle('edit-active', isEdit);
    document.getElementById('editToggleLabel').classList.toggle('active', isEdit);
  }

  function saveData() {
    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    const editToggle = document.getElementById('editToggle');
    if (editToggle.checked) { editToggle.checked = false; toggleEditMode(); }
  }

  function selectRow(row) {
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = row;
    selectedRow.classList.add('selected');
  }

  function initResizable() {
    document.querySelectorAll('th').forEach(col => {
      if (!col.querySelector('.resizer')) {
        const resizer = document.createElement('div');
        resizer.className = 'resizer';
        col.appendChild(resizer);
        resizer.addEventListener('mousedown', function(e) {
          const startX = e.pageX; const startWidth = col.offsetWidth;
          const onMouseMove = (e) => {
            const width = startWidth + (e.pageX - startX);
            if (width > 60) { col.style.width = width + 'px'; col.style.minWidth = width + 'px'; }
          };
          const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); };
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      }
    });
  }

  function addRow() {
    if (!selectedRow) { alert('ì¶”ê°€í•  ìœ„ì¹˜ì˜ í–‰ì„ ë¨¼ì € ë§ˆìš°ìŠ¤ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    const month = selectedRow.getAttribute('data-month');
    const firstRowOfGroup = document.querySelector(`.data-row[data-month="${month}"]`);
    const labelTd = firstRowOfGroup.querySelector('.month-label');
    labelTd.setAttribute('rowspan', parseInt(labelTd.getAttribute('rowspan')) + 1);

    const newRow = document.createElement('tr');
    newRow.className = "data-row";
    newRow.setAttribute('data-month', month);
    newRow.onclick = function() { selectRow(this); };
    newRow.innerHTML = `
      <td class="editable-cell"><select class="table-input"><option value="sell-In">sell-In</option><option value="sell-Thru">sell-Thru</option><option value="Sell-out">Sell-out</option><option value="MDF">MDF</option></select></td>
      <td class="editable-cell"><input type="text" class="table-input" value="ì‹ ê·œ í”„ë¡œê·¸ë¨"></td>
      <td class="editable-cell"><input type="text" class="table-input right mono val-a" value="0" oninput="calcAll()"></td>
      <td class="editable-cell"><input type="text" class="table-input right mono val-b" value="0" oninput="calcAll()"></td>
      <td class="right mono bg-subtotal row-ab">0</td><td class="right mono">0</td>
      <td class="editable-cell"><input type="text" class="table-input right mono val-pay" value="0" oninput="calcAll()"></td>
      <td class="editable-cell"><input type="text" class="table-input" value="-"></td><td class="editable-cell"><input type="text" class="table-input mono" value="-"></td>
      <td class="right mono row-balance">0</td>
    `;
    selectedRow.parentNode.insertBefore(newRow, selectedRow.nextSibling);
    const editToggle = document.getElementById('editToggle');
    if (!editToggle.checked) { editToggle.checked = true; toggleEditMode(); }
    calcAll();
    selectRow(newRow);
  }

  function deleteRow() {
    if (!selectedRow) { alert('ì‚­ì œí•  í–‰ì„ ë¨¼ì € ë§ˆìš°ìŠ¤ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    const month = selectedRow.getAttribute('data-month');
    const monthRows = document.querySelectorAll(`.data-row[data-month="${month}"]`);
    if (monthRows.length <= 1) { alert("í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë°ì´í„° í–‰ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    if (!confirm("ì„ íƒí•œ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    if (selectedRow.querySelector('.month-label')) {
        const nextRow = selectedRow.nextSibling;
        const labelTd = selectedRow.querySelector('.month-label');
        labelTd.setAttribute('rowspan', parseInt(labelTd.getAttribute('rowspan')) - 1);
        nextRow.insertBefore(labelTd, nextRow.firstChild);
    } else {
        const firstRow = monthRows[0];
        const labelTd = firstRow.querySelector('.month-label');
        labelTd.setAttribute('rowspan', parseInt(labelTd.getAttribute('rowspan')) - 1);
    }
    selectedRow.parentNode.removeChild(selectedRow);
    selectedRow = null;
    calcAll();
  }

  // [ê¸°ëŠ¥ ì¶”ê°€] ì›” ì‚­ì œ ê¸°ëŠ¥
  function deleteMonth() {
    const tbody = document.getElementById('rebateBody');
    const allSubtotalRows = tbody.querySelectorAll('.subtotal-row');
    
    if (allSubtotalRows.length === 0) {
      alert("ì‚­ì œí•  ì›” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    if (!confirm("ê°€ì¥ ìµœê·¼ì— ì¶”ê°€ëœ ì›”ì˜ ëª¨ë“  ë°ì´í„°ì™€ ì†Œê³„ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const lastSubRow = allSubtotalRows[allSubtotalRows.length - 1];
    const monthId = lastSubRow.getAttribute('data-month');
    const dataRows = tbody.querySelectorAll(`.data-row[data-month="${monthId}"]`);

    // í•´ë‹¹ ì›”ì˜ ë°ì´í„° í–‰ë“¤ê³¼ ì†Œê³„ í–‰ ì‚­ì œ
    dataRows.forEach(row => tbody.removeChild(row));
    tbody.removeChild(lastSubRow);

    // ì—°ë„ êµ¬ë¶„ì„ ë§Œ ë‚¨ì•˜ì„ ê²½ìš° ì²˜ë¦¬
    const remainingRows = tbody.children;
    if (remainingRows.length > 0 && remainingRows[remainingRows.length - 1].classList.contains('year-divider')) {
        tbody.removeChild(remainingRows[remainingRows.length - 1]);
    }

    calcAll();
    selectedRow = null;
  }

  function addMonth() {
    const rawValue = prompt("ì¶”ê°€í•  ì›”ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2026-01)", "");
    if(!rawValue || !/^\d{4}-\d{2}$/.test(rawValue)) { alert("í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (YYYY-MM)"); return; }
    
    const [year, month] = rawValue.split('-');
    const labelName = `${year}ë…„ ${parseInt(month)}ì›”`;
    const tbody = document.getElementById('rebateBody');

    const dividers = [...document.querySelectorAll('.year-divider')];
    const lastDivider = dividers.pop();
    const lastYearStr = lastDivider ? lastDivider.innerText.trim() : "";
    if (lastYearStr !== `${year}ë…„`) {
        tbody.insertAdjacentHTML('beforeend', `<tr class="year-divider"><td colspan="11" class="center">${year}ë…„</td></tr>`);
    }

    const html = `
      <tr class="data-row" data-month="${rawValue}" onclick="selectRow(this)">
        <td rowspan="2" class="sticky-col center month-label">${labelName}</td>
        <td class="editable-cell"><select class="table-input"><option value="sell-In">sell-In</option><option value="sell-Thru">sell-Thru</option><option value="Sell-out">Sell-out</option><option value="MDF">MDF</option></select></td>
        <td class="editable-cell"><input type="text" class="table-input" value="ì‹ ê·œ í”„ë¡œê·¸ë¨"></td>
        <td class="editable-cell"><input type="text" class="table-input right mono val-a" value="0" oninput="calcAll()"></td>
        <td class="editable-cell"><input type="text" class="table-input right mono val-b" value="0" oninput="calcAll()"></td>
        <td class="right mono bg-subtotal row-ab">0</td><td class="right mono">0</td>
        <td class="editable-cell"><input type="text" class="table-input right mono val-pay" value="0" oninput="calcAll()"></td>
        <td class="editable-cell"><input type="text" class="table-input" value="-"></td><td class="editable-cell"><input type="text" class="table-input mono" value="-"></td>
        <td class="right mono row-balance">0</td>
      </tr>
      <tr class="subtotal-row bg-subtotal" data-month="${rawValue}">
        <td colspan="2" class="center">${parseInt(month)}ì›” ì†Œê³„</td>
        <td class="right mono m-total-a">0</td><td class="right mono m-total-b">0</td><td class="right mono m-total-ab">0</td>
        <td class="right mono">0</td><td class="right mono m-total-pay">0</td><td colspan="2"></td><td class="right mono m-total-bal">0</td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', html);
    calcAll();
  }

  function calcAll() {
    const rows = document.querySelectorAll('.data-row');
    const months = [...new Set([...rows].map(r => r.getAttribute('data-month')))];
    let grandA=0, grandB=0, grandPay=0;
    months.forEach(m => {
      const monthRows = document.querySelectorAll(`.data-row[data-month="${m}"]`);
      let mA=0, mB=0, mPay=0;
      monthRows.forEach(row => {
        const a = parseInt(row.querySelector('.val-a').value.replace(/,/g, '')) || 0;
        const b = parseInt(row.querySelector('.val-b').value.replace(/,/g, '')) || 0;
        const pay = parseInt(row.querySelector('.val-pay').value.replace(/,/g, '')) || 0;
        const ab = a + b; const bal = ab - pay;
        row.querySelector('.row-ab').innerText = ab.toLocaleString();
        row.querySelector('.row-balance').innerText = bal.toLocaleString();
        mA += a; mB += b; mPay += pay;
      });
      const subRow = document.querySelector(`.subtotal-row[data-month="${m}"]`);
      if(subRow) {
        const mAB = mA + mB; const mBal = mAB - mPay;
        subRow.querySelector('.m-total-a').innerText = mA.toLocaleString();
        subRow.querySelector('.m-total-b').innerText = mB.toLocaleString();
        subRow.querySelector('.m-total-ab').innerText = mAB.toLocaleString();
        subRow.querySelector('.m-total-pay').innerText = mPay.toLocaleString();
        subRow.querySelector('.m-total-bal').innerText = mBal.toLocaleString();
      }
      grandA += mA; grandB += mB; grandPay += mPay;
    });
    const gAB = grandA + grandB; const gBal = gAB - grandPay;
    document.getElementById('totalA').innerText = grandA.toLocaleString();
    document.getElementById('totalB').innerText = grandB.toLocaleString();
    document.getElementById('totalAB').innerText = gAB.toLocaleString();
    document.getElementById('totalPay').innerText = grandPay.toLocaleString();
    document.getElementById('totalBal').innerText = gBal.toLocaleString();
  }

  function downloadExcel() {
    const table = document.getElementById('rebateTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "ë¦¬ë² ì´íŠ¸ í˜„í™©"});
    XLSX.writeFile(wb, `Etevers_Rebate_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  window.onload = function() { calcAll(); initResizable(); };
</script>
</body>
</html>
