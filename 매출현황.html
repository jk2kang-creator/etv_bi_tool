<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì—í‹°ë²„ìŠ¤ì´ë¹„í‹° ì£¼ìš” ì§€í‘œ í˜„í™© (v1.3.11)</title>
  
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    /* --- Design System --- */
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#1f2a37; --muted:#6b7280; --border:#e5e7eb;
      --primary:#1f5eff; --primary-2:#0b4bd6; --danger:#e11d48; --success:#10b981;
      --radius: 14px;
      --font: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Noto Sans KR", sans-serif;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--font); }

    .app{ min-height:100vh; display:grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr; grid-template-areas: "head head" "lnb body"; }
    
    /* Header */
    header{ grid-area:head; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:#0f2342; color:#fff; position:sticky; top:0; z-index:50; }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:800; font-size:18px; letter-spacing:-.5px; }
    .brand .pill{ font-size:12px; padding:4px 10px; border:1px solid rgba(255,255,255,.3); border-radius:99px; font-weight:400; opacity:0.9; }
    .top-actions{ display:flex; align-items:center; gap:10px; }
    .btn-sim{ background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.2); color:#fff; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:600; transition:0.2s; }
    .btn-sim:hover{ background:rgba(255,255,255,0.25); }
    .user{ display:flex; align-items:center; gap:10px; padding:6px 12px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.05); border-radius:10px; }
    .avatar{ width:32px;height:32px;border-radius:50%; background:linear-gradient(135deg,#60a5fa,#3b82f6); }

    /* LNB (Modified Spacing) */
    nav{ grid-area:lnb; padding:20px; border-right:1px solid var(--border); background:#fff; position:sticky; top:64px; height:calc(100vh - 64px); overflow-y:auto; display:flex; flex-direction:column; gap:6px; } /* gap increased for uniform spacing */
    .lnb-title{ font-size:12px; font-weight:700; color:#94a3b8; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; }
    .lnb-item{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; cursor:pointer; color:#475569; transition:0.2s; margin-bottom: 0; } /* margin reset, controlled by flex gap */
    .lnb-item:hover{ background:#f1f5f9; color:#1e293b; }
    .lnb-item.active{ background:#eff6ff; color:#2563eb; font-weight:700; }
    .lnb-ico{ font-size:18px; width:24px; text-align:center; }
    .lnb-sub{ font-size:11px; color:#94a3b8; margin-top:2px; font-weight:400; }
    .lnb-divider{ height:1px; background:#e2e8f0; margin:10px 4px; flex-shrink: 0; }

    /* Main */
    main{ grid-area:body; padding:24px; max-width:1600px; overflow-y:auto; }
    
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding:20px; margin-bottom:20px; }
    .card .hd{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border); }
    .card .hd h3{ margin:0; font-size:16px; font-weight:700; color:#1e293b; }
    .section-title h3 { margin:0; font-size:16px; font-weight:700; color:#1e293b; } 

    .controls{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:16px; align-items:end; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; font-weight:600; color:var(--muted); }
    input, select{ height:40px; border-radius:8px; border:1px solid var(--border); padding:0 12px; font-size:13px; outline:none; background:#fff; transition:0.2s; }
    #fileInput { display: none; }

    .btn{ height:40px; padding:0 16px; border-radius:8px; border:none; font-weight:600; font-size:13px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; transition:0.2s; justify-content: center; }
    .btn.primary{ background:var(--primary); color:#fff; } .btn.primary:hover{ background:var(--primary-2); }
    .btn.danger{ background:#fee2e2; color:#ef4444; } .btn.danger:hover{ background:#fecaca; }
    .btn.ghost{ background:#fff; border:1px solid var(--border); color:#333; } .btn.ghost:hover{ background:#f8fafc; }
    .btn.small{ height:32px; font-size:12px; padding:0 12px; border-radius:6px; border:1px solid var(--border); background:#fff; color:#333; }

    /* Table */
    .table-container{ overflow-x:auto; border:1px solid var(--border); border-radius:10px; max-height:400px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; text-align:left; }
    th{ position:sticky; top:0; background:#f8fafc; padding:12px 16px; font-weight:600; color:#64748b; border-bottom:1px solid var(--border); white-space:nowrap; }
    td{ padding:12px 16px; border-bottom:1px solid var(--border); color:#334155; white-space:nowrap; }
    tr:hover{ background:#f8fafc; }
    tfoot td{ background:#f1f5f9; font-weight:800; border-top:2px solid #e2e8f0; }
    .right{ text-align:right; } .mono{ font-family:'Courier New', monospace; font-weight:600; }
    .pos{ color:var(--success); } .neg{ color:var(--danger); }

    /* KPI */
    .kpi-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .kpi-title-main { font-size:16px; font-weight:700; color:#1e293b; display:flex; align-items:center; gap:8px; }
    .kpi-actions { display:flex; align-items:center; gap:10px; }
    .kpi-dept-select { height:34px; border-radius:8px; border:1px solid #cbd5e1; font-size:12px; padding:0 24px 0 10px; outline:none; background:#fff; color:#334155; cursor:pointer; }
    .toggle-group { display:flex; background:#e2e8f0; padding:3px; border-radius:8px; width: 180px; }
    .toggle-btn { flex:1; text-align:center; padding:6px 0; font-size:12px; font-weight:600; border-radius:6px; cursor:pointer; border:none; background:transparent; color:#64748b; transition:0.2s; }
    .toggle-btn.active { background:#fff; color:#1f5eff; box-shadow:0 2px 4px rgba(0,0,0,0.05); }

    .kpi-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; margin-bottom: 24px; }
    .kpi-box{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:20px; display:flex; flex-direction:column; justify-content:center; position:relative; overflow:hidden; }
    .kpi-box::after { content:''; position:absolute; right:-10px; top:-10px; width:60px; height:60px; border-radius:50%; background:var(--bg); opacity:0.5; }
    .kpi-label{ font-size:12px; font-weight:600; color:var(--muted); margin-bottom:8px; }
    .kpi-val{ font-size:24px; font-weight:800; color:#0f172a; letter-spacing:-0.5px; }
    .kpi-sub{ font-size:12px; margin-top:8px; display:flex; align-items:center; gap:6px; }
    .trend-up{ color:var(--success); font-weight:700; } .trend-down{ color:var(--danger); font-weight:700; }
    .badge{ padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700; }
    .badge.blue{ background:#eff6ff; color:#1d4ed8; } .badge.gray{ background:#f1f5f9; color:#475569; }

    /* BI Charts */
    .bi-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .chart-panel{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:20px; height:360px; display:flex; flex-direction:column; }
    .chart-head{ display:flex; justify-content:space-between; margin-bottom:20px; font-size:14px; font-weight:700; color:#333; }
    .chart-body{ flex-grow:1; position:relative; display:flex; align-items:flex-end; justify-content:space-around; padding-bottom:30px; }
    
    .bar-group{ display:flex; flex-direction:column; align-items:center; justify-content:flex-end; height:100%; width:100%; position:relative; margin:0 4px; }
    .bar{ width:50%; min-width:16px; max-width:40px; border-radius:4px 4px 0 0; position:relative; transition:height 0.6s ease; }
    .bar:hover{ filter:brightness(0.95); }
    .bar-label{ position:absolute; bottom:-25px; font-size:11px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60px; text-align:center; }
    .bar-data-top{ margin-bottom: 6px; font-size:11px; font-weight:700; color:#333; text-shadow: 0 1px 2px #fff; }
    .bar-data-sub{ margin-bottom: 2px; font-size:10px; font-weight:700; }
    .chart-overlay{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 10; }
    
    .hbar-list{ display:flex; flex-direction:column; width:100%; height:100%; overflow-y:auto; gap:8px; padding-right:6px; }
    .hbar-item{ display:flex; align-items:center; gap:10px; font-size:12px; }
    .hbar-name{ width:90px; text-align:right; font-weight:600; color:#475569; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .hbar-track{ flex-grow:1; background:#f1f5f9; height:18px; border-radius:4px; overflow:hidden; position:relative; }
    .hbar-fill{ height:100%; background:var(--primary); border-radius:4px; transition:width 0.6s ease; }
    .hbar-val{ font-size:11px; color:#333; width:70px; text-align:right; font-family:'Courier New', monospace; font-weight:700; }

    #colMenu{ position:absolute; top:45px; right:0; background:#fff; border:1px solid var(--border); padding:10px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); display:none; z-index:100; min-width:180px; }
    #colMenu.show{ display:block; }
    #colMenu label{ display:flex; align-items:center; gap:8px; padding:6px; cursor:pointer; font-size:13px; }
    #colMenu label:hover{ background:#f8fafc; border-radius:6px; }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <span>ğŸ“Š</span> ì—í‹°ë²„ìŠ¤ì´ë¹„í‹° ì£¼ìš” ì§€í‘œ í˜„í™© <span class="pill">v1.3.11</span>
    </div>
    <div class="top-actions">
      <button class="btn-sim" onclick="runSimulation()">ğŸ² ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜</button>
      <div class="user"><span class="avatar"></span> <strong style="font-size:13px">Admin</strong></div>
    </div>
  </header>

  <nav>
    <div class="lnb-title">EBT Management</div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ“‰</div><div><div>ì†ìµí˜„í™©</div><div class="lnb-sub">ì „ì‚¬ ì†ìµ ë¶„ì„</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ¯</div><div><div>ëª©í‘œí˜„í™©</div><div class="lnb-sub">ëª©í‘œë‹¬ì„±ìœ¨</div></div></div>
    <div class="lnb-item active"><div class="lnb-ico">ğŸ’°</div><div><div>ë§¤ì¶œí˜„í™©</div><div class="lnb-sub">ì¶œí•˜ì™„ë£Œ ê¸°ì¤€</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ“¦</div><div><div>ì¬ê³ í˜„í™©</div><div class="lnb-sub">Phase 2</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ§¾</div><div><div>ë¯¸ìˆ˜ê¸ˆí˜„í™©</div><div class="lnb-sub">Phase 2</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ“„</div><div><div>ë¯¸ë°œí–‰í˜„í™©</div><div class="lnb-sub">ì„¸ê¸ˆê³„ì‚°ì„œ</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ¦</div><div><div>ìš´ì „ìê¸ˆí˜„í™©</div><div class="lnb-sub">Cash Flow</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">ğŸ·ï¸</div><div><div>ë¦¬ë² ì´íŠ¸ í˜„í™©</div><div class="lnb-sub">Vendor Rebate</div></div></div>
    <div class="lnb-item"><div class="lnb-ico">â†©ï¸</div><div><div>ë°˜í’ˆì´ë ¥ì¡°íšŒ</div><div class="lnb-sub">Return History</div></div></div>
    
    <div class="lnb-divider"></div>
    <div class="lnb-item"><div class="lnb-ico">âš™ï¸</div><div><div>ê´€ë¦¬ì ì„¤ì •</div><div class="lnb-sub">System</div></div></div>
  </nav>

  <main>
    <div class="card">
      <div class="hd">
        <h3>ë§¤ì¶œ í˜„í™© ë¶„ì„</h3>
        <div style="display:flex; gap:8px; position:relative; align-items: center;">
          <div style="font-size:11px; color:#64748b; margin-right:5px; text-align:right;">
            ë§ˆì§€ë§‰ ì—…ë¡œë“œ:<br>
            <span id="lastUploadTime" style="font-weight:700; color:#1e293b">-</span>
          </div>
          <label class="btn ghost small" for="fileInput" style="display:flex;align-items:center;cursor:pointer">â¬†ï¸ ì—‘ì…€ ì—…ë¡œë“œ</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
          
          <button class="btn small" onclick="toggleColMenu()">ğŸ§© ì»¬ëŸ¼ ì„ íƒ</button>
          <div id="colMenu"></div>
          <button class="btn small danger" onclick="init()">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="controls">
        <div class="field"><label>ì‹œì‘ ì›”</label><input type="month" id="f_from" value="2026-01"></div>
        <div class="field"><label>ì¢…ë£Œ ì›” (ê¸°ì¤€)</label><input type="month" id="f_to" value="2026-02" onchange="renderAll()"></div>
        <div class="field"><label>ë³¸ë¶€</label><select id="f_hq" onchange="renderAll()"><option value="ALL">ì „ì²´</option></select></div>
        <div class="field"><label>ë¶€ì„œ</label><select id="f_dept" onchange="renderAll()"><option value="ALL">ì „ì²´</option></select></div>
        <div class="field"><label>ë²¤ë”</label><select id="f_vendor"><option>ì „ì²´</option></select></div>
        <div style="display:flex; gap:8px;">
          <button class="btn primary" style="flex:1" onclick="renderAll()">ğŸ” ì¡°íšŒ</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h3>ì¡°íšŒ ê²°ê³¼ (ìƒì„¸ ë°ì´í„°)</h3>
        <div style="display:flex; gap:10px; align-items:center">
          <span class="muted" style="font-size:12px" id="row_count">0 rows</span>
          <button class="btn ghost small" onclick="alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ')">â¬‡ï¸ Excel ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>
      <div class="table-container">
        <table id="dataTable">
          <thead id="tblHead"></thead>
          <tbody id="tblBody"></tbody>
          <tfoot id="tblFoot"></tfoot>
        </table>
      </div>
    </div>

    <div class="kpi-header">
      <div class="kpi-title-main"><h3>KPI ìš”ì•½</h3></div>
      <div class="kpi-actions">
        <select class="kpi-dept-select" id="kpi_dept_filter" onchange="triggerKpiUpdate()">
          <option value="ALL">ì „ì‚¬ (All)</option>
        </select>
        <div class="toggle-group">
          <button class="toggle-btn active" id="btnModeMonth" onclick="setKpiMode('month')">ì›”ê°„</button>
          <button class="toggle-btn" id="btnModeYtd" onclick="setKpiMode('ytd')">ëˆ„ì  (YTD)</button>
        </div>
      </div>
    </div>
    
    <div class="kpi-grid">
      <div class="kpi-box">
        <div class="kpi-label" id="lbl_kpi_sales">ë§¤ì¶œ ì‹¤ì  (ì›”ê°„)</div>
        <div class="kpi-val" id="kpi_sales">0</div>
        <div class="kpi-sub" id="kpi_sales_growth">-</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label" id="lbl_kpi_target">ë§¤ì¶œ ëª©í‘œ (ì›”ê°„)</div>
        <div class="kpi-val" id="kpi_target" style="color:#64748b">0</div>
        <div class="kpi-sub"><span class="badge gray">Target</span></div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label" id="lbl_kpi_rate">ëª©í‘œ ë‹¬ì„±ìœ¨</div>
        <div class="kpi-val" id="kpi_rate">0%</div>
        <div class="kpi-sub" id="kpi_rate_badge">-</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-label">í‰ê·  ë§ˆì§„ìœ¨</div>
        <div class="kpi-val" id="kpi_margin">0%</div>
        <div class="kpi-sub"><span class="badge gray">ì´ìµë¥ </span></div>
      </div>
    </div>

    <div class="hd" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0; font-size:16px; font-weight:700; color:#1e293b;">BI ë¶„ì„ (Visual Report)</h3>
      <span class="muted" style="font-size:12px">â€» ë§‰ëŒ€: ë§¤ì¶œ(ì–µ), ì„ : ë§ˆì§„ìœ¨(%)</span>
    </div>
    <div class="bi-grid">
      <div class="chart-panel">
        <div class="chart-head">1. ë¶€ì„œë³„ ë§¤ì¶œ(ì–µ) ë° ë§ˆì§„ìœ¨(%)</div>
        <div class="chart-body" id="chart_dept"></div>
      </div>
      <div class="chart-panel">
        <div class="chart-head">2. ì›”ë³„ ë§¤ì¶œ(ì–µ) ë° ì „ì›”ëŒ€ë¹„ ì¦ê°ìœ¨(%)</div>
        <div class="chart-body" id="chart_month"></div>
      </div>
      <div class="chart-panel">
        <div class="chart-head">3. ë²¤ë”ë³„ ë§¤ì¶œ ê·œëª¨ (Top 5)</div>
        <div class="chart-body" id="chart_vendor"></div>
      </div>
      <div class="chart-panel">
        <div class="chart-head">4. ê±°ë˜ì²˜ë³„ ë§¤ì¶œ TOP 10</div>
        <div class="hbar-list" id="chart_customer"></div>
      </div>
    </div>

  </main>
</div>

<script>
  // --- Data & Simulation ---
  const depts = [
    {hq:"ìœ í†µë³¸ë¶€", dept:"ì˜ì—…1íŒ€"}, {hq:"ìœ í†µë³¸ë¶€", dept:"ì˜ì—…2íŒ€"}, 
    {hq:"ì†”ë£¨ì…˜ë³¸ë¶€", dept:"ê¸°ìˆ 1íŒ€"}, {hq:"ì†”ë£¨ì…˜ë³¸ë¶€", dept:"ë³´ì•ˆíŒ€"},
    {hq:"ì‹ ì‚¬ì—…ë³¸ë¶€", dept:"AIíŒ€"}, {hq:"ì‹ ì‚¬ì—…ë³¸ë¶€", dept:"í´ë¼ìš°ë“œíŒ€"}
  ];
  const vendors = ["HP", "Dell", "Cisco", "AWS", "MS", "VMware", "NVIDIA"];
  const customers = ["ì‚¼ì„±ì „ì", "LG CNS", "SKí…”ë ˆì½¤", "ì¹´ì¹´ì˜¤", "ë„¤ì´ë²„", "ì¿ íŒ¡", "í˜„ëŒ€ìë™ì°¨", "ë¡¯ë°ì‡¼í•‘", "ìš°ì•„í•œí˜•ì œë“¤", "í† ìŠ¤", "KT", "POSCO"];
  
  let data = [];
  let kpiMode = 'month';

  function runSimulation() {
    data = [];
    const months = [];
    for(let y=2025; y<=2026; y++) {
      for(let m=1; m<=12; m++) {
        if(y===2026 && m > 4) break;
        months.push(`${y}-${String(m).padStart(2,'0')}`);
      }
    }

    for(let i=0; i<300; i++) {
      const d = depts[Math.floor(Math.random()*depts.length)];
      const vendor = vendors[Math.floor(Math.random()*vendors.length)];
      const customer = customers[Math.floor(Math.random()*customers.length)];
      const month = months[Math.floor(Math.random()*months.length)];
      
      const target = Math.floor(Math.random() * 50 + 10) * 10000000; 
      const sales = Math.floor(target * (Math.random() * 0.6 + 0.6));
      const margin = Math.floor(sales * (Math.random() * 0.1 + 0.05));

      data.push({
        id: i, month, hq: d.hq, dept: d.dept, vendor, customer,
        sales, target, margin,
        achieve: target>0 ? (sales/target*100) : 0,
        margin_rate: sales>0 ? (margin/sales*100) : 0
      });
    }
    data.sort((a,b) => a.month.localeCompare(b.month));
    
    // Update Upload Time
    const now = new Date();
    $("lastUploadTime").innerText = now.getFullYear() + "-" + 
      String(now.getMonth()+1).padStart(2,'0') + "-" + 
      String(now.getDate()).padStart(2,'0') + " " + 
      String(now.getHours()).padStart(2,'0') + ":" + 
      String(now.getMinutes()).padStart(2,'0');

    renderAll();
  }

  // --- Helpers ---
  const $ = (id) => document.getElementById(id);
  const fmtVal = (n) => Math.floor(n).toLocaleString();
  const fmtPct = (n) => n.toFixed(1) + "%";
  const fmtBig = (n) => (n/100000000).toFixed(1) + "ì–µ"; 

  const columns = [
    {key:"month", label:"ì›”", show:true},
    {key:"hq", label:"ë³¸ë¶€", show:true},
    {key:"dept", label:"ë¶€ì„œ", show:true},
    {key:"vendor", label:"ë²¤ë”", show:true},
    {key:"customer", label:"ê±°ë˜ì²˜", show:true},
    {key:"sales", label:"ë§¤ì¶œ", type:"money", show:true},
    {key:"target", label:"ëª©í‘œ", type:"money", show:true},
    {key:"achieve", label:"ë‹¬ì„±ìœ¨", type:"pct", show:true},
    {key:"margin", label:"ë§ˆì§„", type:"money", show:false},
    {key:"margin_rate", label:"ë§ˆì§„ìœ¨", type:"pct", show:true}
  ];

  const pastel = ["#FFB3BA", "#BAE1FF", "#BAFFC9", "#FFFFBA", "#Eecbff"];

  // --- Core: Aggregation ---
  function getGroupedData(dataset) {
    const dimKeys = ['month', 'hq', 'dept', 'vendor', 'customer'].filter(k => {
      const col = columns.find(c => c.key === k);
      return col && col.show;
    });
    const groups = {};
    dataset.forEach(row => {
      const groupKey = dimKeys.map(k => row[k]).join('||');
      if (!groups[groupKey]) {
        groups[groupKey] = { ...row, count: 0, sales:0, target:0, margin:0 };
        ['month', 'hq', 'dept', 'vendor', 'customer'].forEach(k => {
          if(!dimKeys.includes(k)) groups[groupKey][k] = "-"; 
        });
      }
      groups[groupKey].sales += row.sales;
      groups[groupKey].target += row.target;
      groups[groupKey].margin += row.margin;
      groups[groupKey].count += 1;
    });
    return Object.values(groups).map(g => {
      g.achieve = g.target > 0 ? (g.sales / g.target * 100) : 0;
      g.margin_rate = g.sales > 0 ? (g.margin / g.sales * 100) : 0;
      return g;
    });
  }

  // --- Main Render ---
  function renderAll() {
    const fromM = $("f_from").value;
    const toM = $("f_to").value;
    const hq = $("f_hq").value;
    const dept = $("f_dept").value;
    
    const tableFiltered = data.filter(r => {
      if(fromM && r.month < fromM) return false;
      if(toM && r.month > toM) return false;
      if(hq !== "ALL" && r.hq !== hq) return false;
      if(dept !== "ALL" && r.dept !== dept) return false;
      return true;
    });

    const kpiDept = $("kpi_dept_filter").value;
    renderKPIs(toM, kpiDept); 

    const tableData = getGroupedData(tableFiltered);
    renderTable(tableData);

    renderComboChart(tableFiltered, "dept", "chart_dept");
    renderComboChart(tableFiltered, "month", "chart_month");
    renderSimpleBar(tableFiltered, "vendor", "chart_vendor");
    renderTopList(tableFiltered, "customer", "chart_customer");
  }

  // --- KPI Logic ---
  function setKpiMode(mode) {
    kpiMode = mode;
    $("btnModeMonth").className = mode==='month' ? 'toggle-btn active' : 'toggle-btn';
    $("btnModeYtd").className = mode==='ytd' ? 'toggle-btn active' : 'toggle-btn';
    triggerKpiUpdate();
  }

  function triggerKpiUpdate() {
    renderAll();
  }

  function renderKPIs(refMonth, dept) {
    const curData = data.filter(r => {
      if(dept !== "ALL" && r.dept !== dept) return false; 
      if(kpiMode === 'month') return r.month === refMonth;
      if(kpiMode === 'ytd') {
        return r.month >= refMonth.substring(0,4)+"-01" && r.month <= refMonth;
      }
      return false;
    });

    let prevRefMonth = "";
    if(kpiMode === 'month') {
      const d = new Date(refMonth+"-01");
      d.setMonth(d.getMonth()-1);
      prevRefMonth = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0');
    } else {
      const y = parseInt(refMonth.substring(0,4)) - 1;
      const m = refMonth.substring(5,7);
      prevRefMonth = y + "-" + m; 
    }

    const prevData = data.filter(r => {
      if(dept !== "ALL" && r.dept !== dept) return false;
      if(kpiMode === 'month') return r.month === prevRefMonth;
      if(kpiMode === 'ytd') {
        const prevYear = parseInt(refMonth.substring(0,4)) - 1;
        const targetM = prevYear + "-" + refMonth.substring(5,7);
        return r.month >= prevYear+"-01" && r.month <= targetM; 
      }
      return false;
    });

    const curS = curData.reduce((a,b)=>a+b.sales,0);
    const curT = curData.reduce((a,b)=>a+b.target,0);
    const curM = curData.reduce((a,b)=>a+b.margin,0);
    const prevS = prevData.reduce((a,b)=>a+b.sales,0);

    const rate = curT>0 ? (curS/curT*100) : 0;
    const mRate = curS>0 ? (curM/curS*100) : 0;
    
    let growth = 0;
    if(prevS > 0) growth = (curS - prevS) / prevS * 100;

    $("lbl_kpi_sales").innerText = kpiMode==='month' ? "ë§¤ì¶œ ì‹¤ì  (ì›”ê°„)" : "ë§¤ì¶œ ì‹¤ì  (ëˆ„ì )";
    $("lbl_kpi_target").innerText = kpiMode==='month' ? "ë§¤ì¶œ ëª©í‘œ (ì›”ê°„)" : "ë§¤ì¶œ ëª©í‘œ (ëˆ„ì )";
    
    $("kpi_sales").textContent = fmtVal(curS);
    $("kpi_target").textContent = fmtVal(curT);
    $("kpi_rate").textContent = fmtPct(rate);
    $("kpi_margin").textContent = fmtPct(mRate);

    const trendHtml = growth >= 0 
      ? `<span class="trend-up">â–² ${growth.toFixed(1)}%</span>` 
      : `<span class="trend-down">â–¼ ${Math.abs(growth).toFixed(1)}%</span>`;
    
    const labelText = kpiMode==='month' ? "ì „ì›”(MoM) ëŒ€ë¹„ " : "ì „ë…„(YoY) ëŒ€ë¹„ ";
    $("kpi_sales_growth").innerHTML = labelText + trendHtml;

    const badge = $("kpi_rate_badge");
    badge.innerHTML = `<span class="badge ${rate>=100?'blue':'gray'}">${rate>=100?'ëª©í‘œë‹¬ì„±':'ë¯¸ë‹¬ì„±'}</span>`;
  }

  // --- Table Render ---
  function renderTable(data) {
    const thead = $("tblHead"); thead.innerHTML = "<tr>" + columns.map(c=> c.show ? `<th class="${c.type?'right':''}">${c.label}</th>` : '').join('') + "</tr>";
    const tbody = $("tblBody");
    
    tbody.innerHTML = data.map(r => `
      <tr>${columns.map(c => {
        if(!c.show) return '';
        let val = r[c.key];
        if(c.type=='money') val = fmtVal(val);
        if(c.type=='pct') {
          val = fmtPct(val);
          if(c.key=='achieve') return `<td class="right mono ${r.achieve>=100?'pos':'neg'}">${val}</td>`;
        }
        return `<td class="${c.type?'right mono':''}">${val}</td>`;
      }).join('')}</tr>
    `).join('');
    $("row_count").innerText = data.length + " rows (Merged)";

    const tfoot = $("tblFoot");
    const totalS = data.reduce((a,b)=>a+b.sales,0);
    const totalT = data.reduce((a,b)=>a+b.target,0);
    const totalM = data.reduce((a,b)=>a+b.margin,0);
    const totalR = totalT>0 ? totalS/totalT*100 : 0;
    const totalMR = totalS>0 ? totalM/totalS*100 : 0;

    let footerHtml = "<tr>";
    columns.forEach((c, idx) => {
      if(!c.show) return;
      if(idx === 0) { footerHtml += `<td>í•©ê³„</td>`; return; }
      
      let val = "";
      if(c.key === 'sales') val = fmtVal(totalS);
      else if(c.key === 'target') val = fmtVal(totalT);
      else if(c.key === 'margin') val = fmtVal(totalM);
      else if(c.key === 'achieve') val = fmtPct(totalR);
      else if(c.key === 'margin_rate') val = fmtPct(totalMR);
      
      footerHtml += `<td class="right mono" style="font-weight:800;background:#f1f5f9">${val}</td>`;
    });
    footerHtml += "</tr>";
    tfoot.innerHTML = footerHtml;
  }

  // --- Chart Rendering (Static) ---
  function renderComboChart(dataset, key, containerId) {
    const agg = {};
    dataset.forEach(d => {
      if(!agg[d[key]]) agg[d[key]] = {s:0, m:0};
      agg[d[key]].s += d.sales;
      agg[d[key]].m += d.margin;
    });
    const labels = Object.keys(agg).sort();
    const maxS = Math.max(...Object.values(agg).map(v=>v.s)) || 1;
    
    const con = $(containerId); con.innerHTML = "";
    let svgPts = "";
    const w = con.clientWidth || 400; const h = con.clientHeight || 280;
    const step = w / labels.length;

    labels.forEach((l, i) => {
      const v = agg[l];
      const hPct = (v.s / maxS) * 0.65;
      const mPct = v.s > 0 ? (v.m / v.s * 100) : 0;
      const barColor = pastel[i % pastel.length];

      const bar = document.createElement("div");
      bar.className = "bar-group";
      bar.style.width = (100/labels.length) + "%";
      bar.innerHTML = `
        <div class="bar-data-top">${fmtBig(v.s)}</div>
        <div class="bar" style="height:${hPct*100}%; background:${barColor}; width:50%"></div>
        <div class="bar-label" title="${l}">${l}</div>
      `;
      con.appendChild(bar);

      const x = (step * i) + (step / 2);
      const y = h - (Math.min(mPct, 20) / 20 * h * 0.65) - 40; 
      svgPts += `${x},${y} `;
    });

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("class", "chart-overlay");
    svg.innerHTML = `<polyline points="${svgPts}" fill="none" stroke="#f97316" stroke-width="2" stroke-dasharray="4"/>
      ${svgPts.trim().split(' ').map((p,i) => {
         const mPct = (agg[labels[i]].m / agg[labels[i]].s * 100).toFixed(1);
         return `<circle cx="${p.split(',')[0]}" cy="${p.split(',')[1]}" r="4" fill="#fff" stroke="#f97316" stroke-width="2"/>
                 <text x="${p.split(',')[0]}" y="${parseFloat(p.split(',')[1])-10}" text-anchor="middle" fill="#f97316" font-size="11" font-weight="bold">${mPct}%</text>`
      }).join('')}`;
    con.appendChild(svg);
  }

  function renderSimpleBar(dataset, key, containerId) {
    const agg = {};
    dataset.forEach(d => agg[d[key]] = (agg[d[key]]||0) + d.sales);
    const labels = Object.keys(agg).sort((a,b)=>agg[b]-agg[a]).slice(0,5); 
    const max = agg[labels[0]] || 1;
    const con = $(containerId); con.innerHTML = "";
    labels.forEach((l, i) => {
      const hPct = (agg[l] / max) * 0.85;
      const bar = document.createElement("div");
      bar.className = "bar-group";
      bar.innerHTML = `<div class="bar-data-top">${fmtBig(agg[l])}</div><div class="bar" style="height:${hPct*100}%; background:#bae1ff; width:60%"></div><div class="bar-label">${l}</div>`;
      con.appendChild(bar);
    });
  }

  function renderTopList(dataset, key, containerId) {
    const agg = {};
    dataset.forEach(d => agg[d[key]] = (agg[d[key]]||0) + d.sales);
    const sorted = Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const max = sorted[0][1] || 1;
    const con = $(containerId);
    con.innerHTML = sorted.map((item, i) => `
      <div class="hbar-item">
        <div class="hbar-name" title="${item[0]}">${i+1}. ${item[0]}</div>
        <div class="hbar-track"><div class="hbar-fill" style="width:${item[1]/max*100}%"></div></div>
        <div class="hbar-val">${fmtBig(item[1])}</div>
      </div>
    `).join('');
  }

  // --- Init & Event Binding ---
  function toggleColMenu() { $("colMenu").classList.toggle("show"); }
  function initColMenu() {
    const m = $("colMenu");
    m.innerHTML = columns.map((c,i) => `<label><input type="checkbox" ${c.show?'checked':''} onchange="toggleCol(${i})"> ${c.label}</label>`).join('');
  }
  function toggleCol(i) { columns[i].show = !columns[i].show; renderAll(); }

  function init() {
    initColMenu();
    // Default 2026-02
    $("f_to").value = "2026-02";
    
    // Fill HQ/Dept filter (Simulated)
    const hqs = [...new Set(depts.map(d=>d.hq))];
    const deptsList = [...new Set(depts.map(d=>d.dept))];
    hqs.forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; $("f_hq").appendChild(o); });
    deptsList.forEach(v => { 
        const o=document.createElement("option"); o.value=v; o.textContent=v; $("f_dept").appendChild(o); 
        const o2=document.createElement("option"); o2.value=v; o2.textContent=v; $("kpi_dept_filter").appendChild(o2);
    });

    runSimulation();
  }
  
  $("fileInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const now = new Date();
    $("lastUploadTime").innerText = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,'0') + "-" + String(now.getDate()).padStart(2,'0') + " " + String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');

    alert("íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ ì™„ë£Œ (ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ê°±ì‹ )");
    runSimulation(); 
  });

  window.onclick = (e) => { if(!e.target.closest('#colMenu') && !e.target.closest('button[onclick="toggleColMenu()"]')) $("colMenu").classList.remove("show"); }

  init();

</script>
</body>
</html>